<!DOCTYPE html>
<html lang="en">

<head>
  
    <meta charset="utf-8" />
    <title>Ventas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="Premium Multipurpose Admin & Dashboard Template" name="description">
    <meta content="Themesbrand" name="author">
    <!-- App favicon -->
    <link rel="shortcut icon" href="../directorio_dash/images/favicon.png">
    <link rel="stylesheet" type="text/css" href="../css/colors.min.css">

    <!-- DataTables -->
    <link href="../directorio_dash/libs/datatables.net-bs4/css/dataTables.bootstrap4.min.css"
    rel="stylesheet" type="text/css" />
    <!-- Responsive datatable examples -->
    <link href="../directorio_dash/libs/datatables.net-responsive-bs4/css/responsive.bootstrap4.min.css"
    rel="stylesheet" type="text/css" />
    <!-- preloader css -->
    <link rel="stylesheet" href="../directorio_dash/css/preloader.min.css" type="text/css" />
    <!-- Bootstrap Css -->
    <link rel="stylesheet" type="text/css" href="../directorio_dash/css/bootstrap.min.css" id="bootstrap-style" />
    <!-- Icons Css -->
    <link rel="stylesheet" type="text/css" href="../directorio_dash/css/icons.min.css" />
    <!-- App Css-->
    <link rel="stylesheet" type="text/css" href="../directorio_dash/css/app.min.css" id="app-style" />
    <!-- Tipo de letra -->
    <link rel="stylesheet" href="../css/typeFont.css" type="text/css" />
    <!-- scroll -->
    <link rel="stylesheet" href="../css/scrolls.css">

    <style>
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
        }

        input[type=number] { -moz-appearance:textfield; }

        .iconoDatos{
            font-size: 19px;
            background: #0e2222;
            vertical-align:center;
        }
    </style>

</head>

<body>

    <!-- Begin page -->
    <div id="layout-wrapper">

    <!-- =======FIXME: MENU ========================== -->
    <%- include ('../1-admin/menu.ejs')%>
    <!-- =======FIXME: MENU ========================== -->

        <div class="main-content">
            <div class="page-content">
                <div class="container-fluid">
        
                    <!-- start page title -->
                    <div class="row">
                        <div class="col-12">
                            <div class="page-title-box d-sm-flex align-items-center
                                        justify-content-between">
                                <h4 class="mb-sm-0 font-size-18">Ventas </h4>
        
                                <div class="page-title-right">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item"><a href="javascript:
                                                        void(0);">Ventas</a></li>
                                        <li class="breadcrumb-item active">Facturas</li>
                                    </ol>
                                </div>
                            </div>
    <!-- TARJETAS PARA MOSTRAR NÚMERO DE VENTAS + GANANCIAS x VENDEDOR -->
    <div class="row" >
        <!-- TARJETA DE NÚMERO DE VENTAS (PROPIAS & AFILIADOS) -->
        <div class="col-lg-4">
            <div class="card" style="color: #0e2222; border:none;">
                <div class="card-body" style="padding: 31px;height: auto;border-radius: 13px;background: rgb(255,237,195);
                background: linear-gradient(50deg, rgba(255,237,195,1) 0%, rgba(255,232,177,1) 18%, rgba(214,148,148,1) 46%, rgba(212,146,213,1) 60%, rgba(235,181,236,1) 60%, rgba(233,161,233,1) 100%);" >
                    <div class="row">
                        <div class="col-md-2" style="width: auto;">
                            <label class="row icon-demo-content"><i class="fas fa-chart-pie iconoDatos"
                                    style="color:white;border: none;"></i></label>
                        </div>
                        <div class="col-md-8 text-black">
                            <div class="row" style="font-size: 17px;font-weight: 900;margin-top: 9px;margin-bottom: 7%;">Ventas totales
                            </div>
                        </div>
                    </div>
                
                    <div class="row" style="margin-bottom: -13px;">
                        <div class="col-md-6" style="font-size: 12px;font-weight: 100;">
                            <div class="row">Número de ventas</div>
                            <div class="row" style="font-size: 29px; font-weight: 800;margin-bottom: 3px;">
                                <strong>
                                   <%=sumaTotalVentas%> 
                                </strong>
                            </div>
                        </div>
                        <div class="col-md-6" style="font-size: 12px;font-weight: 100;">
                            <div class="row">Ganacias brutas</div>
                            <div class="row" style="font-size: 29px; font-weight: 800;">
                                <strong>$<%=sumaValor%></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TARJETA DE GANANCIAS (PROPIAS & AFILIADOS) -->
        <div class="col-lg-4">
            <div class="card" style="color: #0e2222; border:none">
                <div class="card-body"
                    style="padding: 31px;height: auto;border-radius: 13px;background: rgb(188,169,231); background: linear-gradient(50deg, rgba(188,169,231,1) 0%, rgba(188,169,231,1) 18%, rgba(175,155,218,1) 46%, rgba(188,169,231,1) 60%, rgba(235,231,244,1) 60%, rgba(188,169,231,1) 100%);">
                    <div class="row">
                        <div class="col-md-2" style="width: auto;">
                            <label class="row icon-demo-content"><i class="fas fa-chart-line iconoDatos" style="color:white;border: none;"></i></label>
                        </div>
                        <div class="col-md-8 text-black">
                            <div class="row" style="font-size: 17px;font-weight: 900;margin-top: 9px;margin-bottom: 6.6%;">Ganancias</div>
                        </div>
                    </div>
                  
                    <div class="row" style="margin-bottom: -11px;">
                        <div class="col-md-6" style="font-size: 12px;font-weight: 100;">
                            <div class="row">Comisiones pagadas</div>
                            <div class="row" style="font-size: 29px; font-weight: 800;margin-bottom: 3px;">
                                <strong>$<%=comisionesPagadas%></strong>
                            </div>
                        </div>
        
                        <div class="col-md-6" style="font-size: 12px;font-weight: 100;">
                            <div class="row">Ganacias de empresa</div>
                            <div class="row" style="font-size: 29px; font-weight: 800;">
                                <strong>$<%=gananciasEmpresa%></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- FINAL TARJETAS -->
                        </div>
                    </div>
                    <!-- end page title -->
                    
        
                    <div class="table-responsive mb-4 ">
                        <table class="table align-middle datatable dt-responsive table-check nowrap "
                            style="border-collapse: collapse; border-spacing: 0 8px; width: 100%;">
                            <thead>
                                <th scope="col" title="Id de factura">Factura</th>
                                <th scope="col" title="Fecha de factura">Fecha de instalación</th>
                                <th scope="col">Nombre del cliente</th>
                                <th scope="col">Producto</th>
                                <th scope="col">Valor</th>
                                <th scope="col">Vendedor</th>
                                <th scope="col">Afiliados</th>
                                <th scope="col">Comisiones</th>
                                <th scope="col">Ganancias</th>
                                <th scope="col">Estado</th>
                            </thead>
        
                            <tbody>
                                <% if(arrayVentas) {%>
                                    <% arrayVentas.forEach((venta)=>{ %>
                                        <% if (venta.factura.id) { %>
                                        <tr>
                                            <td>
                                                <button style="background: none;border: none;margin: 0;"
                                                    onclick="editarFactura('<%=venta.factura.id%>')">
                                                    <%= venta.factura.id %>
                                                </button>
                                            </td>
                                            <td>
                                                <%= venta.factura.fecha %>
                                            </td>
                                            <td style="text-transform: capitalize;">
                                                <%= venta.nombre %>
                                                    <%= venta.apellido %>
                                            </td>
                                            <td>
                                                <%= venta.sistema %>
                                            </td>
                                            <td class="monto">
                                                $<%= venta.monto_aprobado %>
                                            </td>
                                            <td style="text-transform: capitalize;">
                                                <%= venta.vendedores[0].nombre %>
                                            </td>
                                            <td style="text-transform: capitalize;">
                                                <%if (venta.vendedores.length > 1) {%>
                                                    <%for(let i = 1; i < venta.vendedores.length; i++){%>
                                                        <%=venta.vendedores[i].nombre%><br>
                                                    <% } %>
                                                <%}else{%>
                                                    N/A
                                                <%}%>
                                            </td>
                                            <td>
                                                <% if(venta.factura.estadoTxt == "Pagada") {%>
                                                    $<%= venta.comision_total %>
                                                <%}else{%>
                                                    Por definir
                                                <%}%>
                                            </td>
                                            <td>
                                                <% if(venta.ganancias) {%>
                                                    $<%= venta.ganancias.total %>
                                                <%}else{%>
                                                    Por definir
                                                <%}%>
                                            </td>
                                            <td>
                                                <div class="badge <%= venta.factura.estadoColor %> font-size-12">
                                                    <%= venta.factura.estadoTxt %>
                                                </div>
                                            </td>
                                        </tr>
                                        <% } %>
                                    <%})%>
                                <% } %>
                            </tbody>
        
                        </table>
                        
                        <button id="btnSidebar" data-bs-toggle="offcanvas" data-bs-target="#sidebarRight" aria-controls="sidebarRight" style="background: none;border: none;margin: 0;"></button>
                        <div class="offcanvas offcanvas-end" tabindex="-1" id="sidebarRight"
                            style="width: 50%; padding: 0px 0px 0px 37px; visibility: hidden;" aria-labelledby="sidebarRightLabel"
                            aria-hidden="true">
                            <div class="offcanvas-header">
                                <h1 id="offcanvasRightLabel" style=" font-size: 111%; "></h1>
                                <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                            </div>
                            <div class="offcanvas-body scroll_vertical">
                                <div class="row">
                                    <div class="col-lg-12" style="margin-left: -1%;">
                                        <div class="invoice-title">
                                            <div class="d-flex align-items-start">
                                                <div class="flex-grow-1">
                                                    <div class="mb-4">
                                                        <img src="../directorio_dash/images/logo.svg" alt="" height="40"><span
                                                            class="logo-txt"></span>
                                                    </div>
                                                </div>
                                                <!-- BOTÓN GUARDAR FACTURA - ENVIAR A DB -->
                                                <div class="flex-grow-1" >
                                                    <a id="btnReportarFactura" class="btn btn-primary w-md waves-effect waves-light" style="border-radius: 17px;">Reportar como pagada</a>
                                                </div>
                                                <div class="flex-shrink-0">
                                                    <div class="mb-4">
                                                        <h4 class="float-end font-size-16" style="padding-top: 10px;">Factura: <span id="idFactura"></span>
                                                        </h4>
                                                    </div>
                                                </div>
                                            </div>
                            
                                        <hr class="mb-4">
                            
                                        <!-- **INICIO** Pestañas para gestionar vendedores -->
                                        <ul class="nav justify-content-start nav-pills card-header-pills mb-3" role="tablist">
                                            <li  class="nav-item waves-effect waves-light">
                                                <a id="tabFactura1" class="nav-link active" data-bs-toggle="tab" href="#v1" role="tab" aria-selected="true">
                                                    <span class="d-block d-sm-none"><i class="fas fa-home"></i></span>
                                                    <span class="d-none d-sm-block">Vendedor Principal</span>
                                                </a>
                                            </li>
                            
                                            <li id="tabFactura2" class="nav-item waves-effect waves-light">
                                                <a class="nav-link otrosTab" data-bs-toggle="tab" href="#v2" role="tab" aria-selected="false">
                                                    <span class="d-block d-sm-none"><i class="far fa-user"></i></span>
                                                    <span class="d-none d-sm-block">Vendedor 2</span>
                                                </a>
                                            </li>
                                            <li class="nav-item waves-effect waves-light" id="tabFactura3">
                                                <a class="nav-link otrosTab" data-bs-toggle="tab" href="#v3" role="tab" aria-selected="false">
                                                    <span class="d-block d-sm-none"><i class="far fa-envelope"></i></span>
                                                    <span class="d-none d-sm-block">Vendedor 3</span>
                                                </a>
                                            </li>
                                            <li class="nav-item waves-effect waves-light" id="tabFactura4">
                                                <a class="nav-link otrosTab" data-bs-toggle="tab" href="#v4" role="tab" aria-selected="false">
                                                    <span class="d-block d-sm-none"><i class="fas fa-cog"></i></span>
                                                    <span class="d-none d-sm-block">Vendedor 4</span>
                                                </a>
                                            </li>
                                            
                                            <!-- Costos adicionales x Factura -->
                                            <li class="nav-item waves-effect waves-light" id="tabCostos">
                                                <a class="nav-link otrosTab" data-bs-toggle="tab" href="#costosExtras" role="tab" aria-selected="false">
                                                    <span class="d-block d-sm-none"><i class="fas fa-cog"></i></span>
                                                    <span class="d-none d-sm-block">Costos operativos</span>
                                                </a>
                                            </li>
                                        </ul>
                                        <!-- **FIN** Pestañas para gestionar vendedores -->
                            
                                        <!-- **INICIO** CONTENIDO DE LOS TABS - INFO DE VENDEDORES  -->
                                        <input type="hidden" id="idFacturaActual">
                                        <div class="tab-content p-3 text-muted">
                                        
                                            <!-- Vendedor 1 -->
                                            <div class="tab-pane active" id="v1" role="tabpanel">
                                                <div class="row">
                                                    <div class="col-sm-6">
                                                        <h5 class="font-size-15 mb-2">Producto</h5>
                                                        <p class="mb-1 producto"></p>
                                                        <p class="mb-1 badge badge-soft-success font-size-12">
                                                            $<span class="valor"></span></p>
                                                        <h5 class="font-size-14 mb-2">Cliente </h5>
                                                        <p class="mb-1 badge badge-soft-dark font-size-12 idCliente"></p>
                                                        <p class="mb-1 telCliente"></p>
                                                        <p class="direccionCliente"></p>
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <div>
                                                            <h5 class="font-size-15">Fecha de instalación</h5>
                                                            <p class="fecha"></p>
                                                        </div>
                                                    
                                                        <div class="mt-4">
                                                            <h5 class="font-size-15">Vendedor</h5>
                                                            <p class="mb-1 badge badge-soft-dark font-size-12" id="idVendedor1"></p>
                                                            <p class="mb-1">Nivel: <span id="nivelVendedor1"></span></p>
                                                            <p class="mb-1" id="telVendedor"></p>
                                                        </div>
                                                    
                                                    </div>
                                                </div>
                                                <div class="py-2 mt-3">
                                                    <h5 class="badge badge-soft-success font-size-12">Comisión base:
                                                        $<span id="comisionBase1"></span></h5>
                                                </div>
                                        
                                                <div class="py-2 mt-3">
                                                    <h5 class="font-size-15" id="tituloDeduccion_1">Deducciones</h5>
                                                </div>
                                        
                                                <!-- TABLA PARA DEDUCCIONES VENDEDOR PRINCIPAL -->
                                                <div class="table-responsive" style="padding: 12px;" id="divDeducciones">
                                                    <!-- Cargando la tabla desde un Script -->
                                                </div>
                                        
                                            </div>
                                        
                                            <!-- Vendedor 2 -->
                                            <div class="tab-pane" id="v2" role="tabpanel">
                                                <div class="row">
                                                    <div class="col-sm-6">
                                                        <h5 class="font-size-15 mb-2">Producto</h5>
                                                        <p class="mb-1 producto"></p>
                                                        <p class="mb-1 badge badge-soft-success font-size-12">
                                                            $<span class="valor"></span></p>
                                                        <h5 class="font-size-14 mb-2">Cliente </h5>
                                                        <p class="mb-1 badge badge-soft-dark font-size-12 idCliente"></p>
                                                        <p class="mb-1 telCliente"></p>
                                                        <p class="direccionCliente"></p>
                                                    </div>
                                        
                                                    <div class="col-sm-6">
                                                        <div>
                                                            <h5 class="font-size-15">Fecha de instalación</h5>
                                                            <p class="fecha"></p>
                                                        </div>
                                                    
                                                        <div class="mt-4">
                                                            <h5 class="font-size-15">Vendedor</h5>
                                                            <p class="mb-1 badge badge-soft-dark font-size-12" id="idVendedor2"></p>
                                                            <p class="mb-1">Nivel: <span id="nivelVendedor2"></span></p>
                                                            <p class="mb-1" id="telVendedor2"></p>
                                                        </div>
                                                    
                                                    </div>
                                                </div>
                                                <div class="py-2 mt-3">
                                                    <h5 class="badge badge-soft-success font-size-12">Comisión base:
                                                        $<span id="comisionBase2"></span> </h5>
                                                </div>
                                        
                                                <div class="py-2 mt-3">
                                                    <h5 class="font-size-15" id="tituloDeduccion_2">Deducciones</h5>
                                                </div>
                                        
                                                <!-- TABLA PARA DEDUCCIONES VENDEDOR 2 -->
                                                <div class="table-responsive" style="padding: 12px;" id="divDeducciones2">
                                                    <!-- Cargando la tabla desde un Script -->
                                                </div>
                                        
                                            </div>
                                        
                                            <!-- Vendedor 3 -->
                                            <div class="tab-pane" id="v3" role="tabpanel">
                                                <div class="row">
                                        
                                                    <div class="col-sm-6">
                                                        <h5 class="font-size-15 mb-2">Producto</h5>
                                                        <p class="mb-1 producto"></p>
                                                        <p class="mb-1 badge badge-soft-success font-size-12">
                                                            $<span class="valor"></span></p>
                                                        <h5 class="font-size-14 mb-2">Cliente </h5>
                                                        <p class="mb-1 badge badge-soft-dark font-size-12 idCliente"></p>
                                                        <p class="mb-1 telCliente"></p>
                                                        <p class="direccionCliente"></p>
                                                    </div>
                                        
                                                    <div class="col-sm-6">
                                                        <div>
                                                            <h5 class="font-size-15">Fecha de instalación</h5>
                                                            <p class="fecha"></p>
                                                        </div>
                                                    
                                                        <div class="mt-4">
                                                            <h5 class="font-size-15">Vendedor</h5>
                                                            <p class="mb-1 badge badge-soft-dark font-size-12" id="idVendedor3"></p>
                                                            <p class="mb-1">Nivel: <span id="nivelVendedor3"></span></p>
                                                            <p class="mb-1" id="telVendedor3"></p>
                                                        </div>
                                                    
                                                    </div>
                                        
                                                </div>
                                                <div class="py-2 mt-3">
                                                    <h5 class="badge badge-soft-success font-size-12">Comisión base:
                                                        $<span id="comisionBase3"></span> </h5>
                                                </div>
                                        
                                                <div class="py-2 mt-3">
                                                    <h5 class="font-size-15" id="tituloDeduccion_3">Deducciones</h5>
                                                </div>
                                        
                                                <!-- TABLA PARA DEDUCCIONES VENDEDOR 3 -->
                                                <div class="table-responsive" style="padding: 12px;" id="divDeducciones3">
                                                    <!-- Cargando la tabla desde un Script -->
                                                </div>

                                            </div>
                                        
                                            <!-- Vendedor 4 -->
                                            <div class="tab-pane" id="v4" role="tabpanel">
                                                <div class="row">
                                                    <div class="col-sm-6">
                                                    
                                                        <h5 class="font-size-15 mb-2">Producto</h5>
                                                        <p class="mb-1 producto"></p>
                                                        <p class="mb-1 badge badge-soft-success font-size-12">
                                                            $<span class="valor"></span></p>
                                                        <h5 class="font-size-14 mb-2">Cliente </h5>
                                                        <p class="mb-1 badge badge-soft-dark font-size-12 idCliente"></p>
                                                        <p class="mb-1 telCliente"></p>
                                                        <p class="direccionCliente"></p>
                                                    
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <div>
                                                            <h5 class="font-size-15">Fecha de instalación</h5>
                                                            <p class="fecha"></p>
                                                        </div>
                                                    
                                                        <div class="mt-4">
                                                            <h5 class="font-size-15">Vendedor</h5>
                                                            <p class="mb-1 badge badge-soft-dark font-size-12" id="idVendedor4"></p>
                                                            <p class="mb-1">Nivel: <span id="nivelVendedor4"></span></p>
                                                            <p class="mb-1" id="telVendedor4"></p>
                                                        </div>
                                                    
                                                    
                                                    </div>
                                                </div>
                                                <div class="py-2 mt-3">
                                                    <h5 class="badge badge-soft-success font-size-12">Comisión base:
                                                        $<span id="comisionBase4"></span> </h5>
                                                </div>
                                        
                                                <div class="py-2 mt-3">
                                                    <h5 class="font-size-15" id="tituloDeduccion_4">Deducciones</h5>
                                                </div>
                                        
                                                <!-- TABLA PARA DEDUCCIONES VENDEDOR 4 -->
                                                <div class="table-responsive" style="padding: 12px;" id="divDeducciones4">
                                                    <!-- Cargando la tabla desde un Script -->
                                                </div>
                                            </div>

                                            <!-- Costos Adicionales x Factura -->
                                            <div class="tab-pane" id="costosExtras" role="tabpanel">
                                                <div class="row">
                                                    <div class="col-sm-6">
                                                    
                                                        <h5 class="font-size-15 mb-2">Producto</h5>
                                                        <p class="mb-1 producto"></p>
                                                        <p class="mb-1 badge badge-soft-success font-size-12">
                                                            $<span class="valor"></span></p>
                                                        <h5 class="font-size-14 mb-2">Cliente </h5>
                                                        <p class="mb-1 badge badge-soft-dark font-size-12 idCliente"></p>
                                                        <p class="mb-1 telCliente"></p>
                                                        <p class="direccionCliente"></p>
                                                    
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <div>
                                                            <h5 class="font-size-15">Fecha de instalación</h5>
                                                            <p class="fecha"></p>
                                                        </div>
                                                    
                                                        <div class="mt-4">
                                                            <h5 class="font-size-15">3C Sigma Water System</h5>
                                                        </div>
                                                    
                                                    </div>
                                                </div>
                                                <div class="py-2 mt-3">
                                                    <h5 class="badge badge-soft-success font-size-12">Ganancia base: $<span id="gananciaBase"></span></h5>
                                                </div>
                                        
                                                <div class="py-2 mt-3">
                                                    <h5 class="font-size-15">Costos operativos
                                                        <button type="button" onclick="agregarCosto()" id="btnAddCostos" class="btn btn-primary btn-xs" style="float: right"><i class="mdi mdi-plus"></i></button>
                                                    </h5>
                                                </div>
                                        
                                                <!-- TABLA para Costos Extras - Last Tab -->
                                                <div class="table-responsive" style="padding: 12px;" id="divCostosExtras">
                                                    <table class="table table-nowrap align-middle" id="tablaCostosExtras">
                                                        <tfoot>
                                                            <tr>
                                                                <td class="text-end" style="font-weight: 700;font-size: 15px;"><b>Subtotal</b></td>
                                                                <td colspan="2">$<span id="subtotalCostos">0</span></td>
                                                            </tr>
                                                            <tr>
                                                                <td class="text-end" style="font-weight: 700;font-size: 15px;"><b>Ganancias totales</b></td>
                                                                <td colspan="2">$<span id="totalGanancias"></span></td>
                                                                <input type="hidden" id="idCliente_">
                                                                <input type="hidden" id="gananciaTotal">
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                </div>
                                            </div>

                                        </div>
                                        <!-- **FIN** CONTENIDO DE LOS TABS - INFO DE VENDEDORES  -->
                            
                                    </div>
                                </div>
                            </div>
                        </div>
        
                    </div>
                    <!-- end table -->
                </div>
            </div>
        </div>
        
        <!-- =======FIXME: copyright ========================== -->
        <%- include ('../partials/copyright.ejs')%>
        <!-- =======FIXME: copyright ========================== -->
  
    </div>
  
<!-- Right Sidebar -->
<div class="right-bar">
    <div data-simplebar class="h-100">
        <div class="rightbar-title d-flex align-items-center bg-dark p-3">
            <a href="javascript:void(0);" class="right-bar-toggle ms-auto">
                <i class="mdi mdi-close noti-icon"></i>
            </a>
        </div>
    </div> <!-- end slimscroll-menu-->
</div>
<!-- /Right-bar -->
   <!-- JAVASCRIPT -->
<script src="../directorio_dash/js/scripts_personalizadosdash.js"></script>
<script src="../directorio_dash/libs/jquery/jquery.min.js"></script>
<script src="../directorio_dash/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="../directorio_dash/libs/metismenu/metisMenu.min.js"></script>
<script src="../directorio_dash/libs/simplebar/simplebar.min.js"></script>
<script src="../directorio_dash/libs/node-waves/waves.min.js"></script>
<script src="../directorio_dash/libs/feather-icons/feather.min.js"></script>
<!-- pace js -->
<script src="../directorio_dash/libs/pace-js/pace.min.js"></script>
<!-- Required datatable js -->
<script src="../directorio_dash/libs/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="../directorio_dash/libs/datatables.net-bs4/js/dataTables.bootstrap4.min.js"></script>
<!-- Responsive examples -->
<script src="../directorio_dash/libs/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
<script src="../directorio_dash/libs/datatables.net-responsive-bs4/js/responsive.bootstrap4.min.js"></script>
<!-- init js -->
<script src="../directorio_dash/js/pages/datatable-pages.init.js"></script>
<!-- Table Editable plugin -->
<script src="../directorio_dash/libs/table-edits/build/table-edits.min.js"></script>
<script src="../directorio_dash/js/pages/table-editable.int.js"></script> 
 <script src="../directorio_dash/js/app.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.8/dist/sweetalert2.all.min.js"></script>

<script type="text/javascript">
    let v1 = 1, v2 = 1, v3 = 1, v4 = 1, cont = 1, arrayDeducciones = [], arrayCostos = [], storage = {};
    const subtotalCostos = $('#subtotalCostos');
    const totalGanancias = $('#totalGanancias');
    const gananciaTotal = $('#gananciaTotal');

    function _crearTablaDeducciones(num, datos) {
        let tabla = `<table class="table table-nowrap align-middle" id="tablaDeducciones${num}">`
        if (datos) {
            tabla += `<thead>
                        <tr>
                            <th>Descripción</th>
                            <th>Monto</th>
                        </tr>
                    </thead>`
        } else {
            tabla += `<thead>
                        <tr>
                            <th>Descripción</th>
                            <th>Monto</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>`
        }
        tabla += `<tbody></tbody>
                            <tfoot>
                                <tr>
                                    <td class="text-end" style="font-weight: 700;font-size: 15px;"><b>Subtotal</b></td>
                                    <td colspan="2">$<span id="subtotal${num}">0</span></td>
                                </tr>
                                <tr id="porcentaje-ganar${num}">
                                    <td class="text-end" style="font-weight: 700;font-size: 15px;"><b>Porcentaje ganancia</b></td>
                                    <td colspan="2">50%</td>
                                </tr>
                                <tr>
                                    <td class="text-end" style="font-weight: 700;font-size: 15px;"><b>Comisión Total</b></td>
                                    <td colspan="2">$<span id="total${num}"></span></td>
                                    <input type="hidden" id="deduccionTotal${num}" value="">
                                </tr>
                            </tfoot>
                        </table>
                    `
        return tabla;
    }

    // Parametros (idCliente, Pestaña, Nivel del Vendedor)
    function _btnAddDeduccion(idCliente, numTab, nivel) {
        return $('#tituloDeduccion_'+numTab).append(`<button type="button" onclick="agregarDeduccion(${idCliente}, 'tab${numTab}', ${nivel})" class="btn btn-primary btn-xs btnAddDeduccion" style="float: right"><i class="mdi mdi-plus"></i></button>`);
    }

    function editarFactura(idFactura) {
        $("#tabFactura2").css('display', 'none')
        $("#tabFactura3").css('display', 'none')
        $("#tabFactura4").css('display', 'none')
        $('.btnAddDeduccion').remove()
        $('#tablaDeducciones1').remove()
        $('#tablaDeducciones2').remove()
        $('#tablaDeducciones3').remove()
        $('#tablaDeducciones4').remove()
        $('#tablaCostosExtras>tbody').remove()
        $('#tablaCostosExtras').append('<tbody></tbody>')
        $("#headTbl").remove()
        subtotalCostos.text(0)
        v1 = 1, v2 = 1, v3 = 1, v4 = 1;
        arrayDeducciones = []
        arrayCostos = []

        $("#idFacturaActual").val(idFactura);

        $("#btnReportarFactura").attr('onclick', `reportarFactura('${idFactura}')`)

        fetch('/deducciones', {
          method: 'POST',
          body: JSON.stringify({idFactura}),
          headers: {'Content-Type': 'application/json'}
        }).then(res => res.json())
          .catch(error => console.error('Error:', error))
          .then(datos => {
            if (datos) {

                storage = datos // Variable Global..
                let dt = undefined // Deducciones Totales|
                
                const idCliente = datos.id
                $("#idCliente_").val(idCliente)
                const nombreCliente = datos.nombre + " " + datos.apellido
                $("#idFactura").text(idFactura)
                $(".producto").text(datos.sistema)
                $(".valor").text(datos.monto_aprobado)
                $(".idCliente").text(nombreCliente)
                $(".telCliente").text(datos.telefono)
                $(".direccionCliente").text(datos.direccion)
                $(".fecha").text(datos.factura.fecha)
                
                const vendedor_principal = datos.vendedores[0]
                let vendedor2 = {}, vendedor3 = {}, vendedor4 = {};
                datos.vendedores[1] ? vendedor2 = datos.vendedores[1] : vendedor2 = false;
                datos.vendedores[2] ? vendedor3 = datos.vendedores[2] : vendedor3 = false;
                datos.vendedores[3] ? vendedor4 = datos.vendedores[3] : vendedor4 = false;
                
                vendedor_principal.comision_base = vendedor_principal.comision_base.toFixed(1)

                // console.log("DATOS FACTURA >>>> ",datos)
                let cabeceraCostos = ``
                if (datos.factura.estadoTxt == "Pagada") {
                    $("#btnReportarFactura").css('display', 'none')
                    $('.btnAddDeduccion').remove()
                    const tablaDeducciones_v1 = _crearTablaDeducciones(1, true)
                    $('#divDeducciones').append(tablaDeducciones_v1);
                    /////////////////////////////////////////////////////////////////////////////////////////////////////
                    /* SI LA FACTURA FUE PAGADA - MOSTRAR COSTOS OPERACIONALES SI LOS TIENE + VALOR DE GANANCIAS */
                    $('#btnAddCostos').hide() // Ocultar botón de agregar nuevo costo
                    cabeceraCostos = `<thead id="headTbl">
                                                <tr>
                                                    <th>Descripción</th>
                                                    <th>Monto</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>`;
                    let costos = ``, subtotal = 0;
                    if (datos.costos_adicionales){
                        datos.costos_adicionales.forEach(x => {
                            costos += `<tr id="${x.row}">
                                <td>${x.descripcion}</td>
                                <td>${x.monto}</td>
                            </tr>`
                            subtotal += parseFloat(x.monto)
                        })
                    }
                    $('#gananciaBase').text(datos.ganancias.base)
                    subtotalCostos.text(subtotal)
                    totalGanancias.text(datos.ganancias.total)
                    gananciaTotal.val(datos.ganancias.total)
                    storage.gananciaBase = parseFloat(datos.ganancias.base);
                    storage.gananciaTotal = parseFloat(datos.ganancias.total)
                    $('#tablaCostosExtras').append(costos);
                    /* FIN DE COSTOS + GANANCIAS */
                    /////////////////////////////////////////////////////////////////////////////////////////////////////
                } else {
                    $("#btnReportarFactura").css('display', 'inline-block')
                    _btnAddDeduccion(idCliente, '1', vendedor_principal.nivel)
                    const tablaDeducciones_v1 = _crearTablaDeducciones(1, false)
                    $('#divDeducciones').append(tablaDeducciones_v1);
                    /////////////////////////////////////////////////////////////////////////////////////////////////////
                    // OPERACIONES PARA COSTOS ADICIONALES - ÚLTIMO TAB
                    $('#btnAddCostos').show() // Mostrar botón de agregar nuevo costo
                    cabeceraCostos = `<thead id="headTbl">
                                                <tr>
                                                    <th>Descripción</th>
                                                    <th>Monto</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>`;
                    const comisionTotal0 = storage.vendedores.map(x => x.comision_final).reduce((prev, curr) => prev + curr, 0);
                    const gananciaBase = parseFloat(datos.monto_aprobado)-parseFloat(comisionTotal0).toFixed(1);
                    console.log("\nMonto aprobado >>> ", datos.monto_aprobado)
                    console.log("Comisión Total Vendedores >>> ", comisionTotal0)
                    console.log("Ganancia Base Inicial >>> ", gananciaBase)
                    $("#gananciaBase").text(gananciaBase)
                    totalGanancias.text(parseFloat(gananciaBase))
                    gananciaTotal.val(parseFloat(gananciaBase))
                    storage.gananciaBase = parseFloat(gananciaBase);
                    storage.gananciaTotal = parseFloat(gananciaBase);
                    /////////////////////////////////////////////////////////////////////////////////////////////////////
                }
                $('#tablaCostosExtras').append(cabeceraCostos);

                $("#idVendedor1").text(vendedor_principal.nombre)
                $("#nivelVendedor1"). text(vendedor_principal.nivel)
                $("#telVendedor").text(vendedor_principal.telefono)
                $("#comisionBase1").text(vendedor_principal.comision_base)
                $("#porcentaje-ganar1").css('display', 'none')
                let comisionFinal = vendedor_principal.comision_base

                vendedor_principal.deducciones ? dt = vendedor_principal.deducciones : dt = dt;
                
                if (dt) {
                    let subtotal = 0, dt1 = [];
                    dt.forEach(x => { 
                        x.forEach(n => {
                            if (n.tab == 'tab1') dt1.push(n)
                        })
                    })
                    
                    if (dt1.length > 0) {
                        let deducciones1 = ``, i = 1;
                        dt1.forEach(x => {
                            deducciones1 += `<tr id="${x.tab}_row${i}">
                                <td>${x.descripcion}</td>
                                <td>${x.monto}</td>
                            </tr>`
                            subtotal += parseFloat(x.monto)
                            i++;
                        })
                        $('#tablaDeducciones1').append(deducciones1);
                    }

                    $('#subtotal1').text(subtotal)
                    comisionFinal = parseFloat(vendedor_principal.comision_base-subtotal)
                    $("#porcentaje-ganar1").css('display', 'none')
                    if (vendedor_principal.nivel == 4) {
                        $("#porcentaje-ganar1").css('display', 'table-row')
                        comisionFinal = parseFloat((vendedor_principal.comision_base-subtotal)/2)
                    }

                } else {
                    // Parametros (idCliente, Pestaña, Nivel del Vendedor)
                    // _btnAddDeduccion(idCliente, '1', vendedor_principal.nivel)
                    // const tablaDeducciones_v1 = _crearTablaDeducciones(1, false)
                    // $('#divDeducciones').append(tablaDeducciones_v1);
                    $("#porcentaje-ganar1").css('display', 'none')
                    if (vendedor_principal.nivel == 4) {
                        $("#porcentaje-ganar1").css('display', 'table-row')
                        comisionFinal = parseFloat(vendedor_principal.comision_base/2)
                    }
                }
                
                $('#total1').text(comisionFinal)
                $("#deduccionTotal1").val(comisionFinal)
                // $("#deduccionTotal1").val(parseFloat($("#total1").text()))

                if (vendedor2) {

                    vendedor2.comision_base = vendedor2.comision_base.toFixed(1)
                    $("#tabFactura2").css('display', 'block')
                    $("#idVendedor2").text(vendedor2.nombre)
                    $("#nivelVendedor2").text(vendedor2.nivel)
                    $("#telVendedor2").text(vendedor2.telefono)
                    $("#comisionBase2").text(vendedor2.comision_base)
                    $("#total2").text(vendedor2.comision_base)
                    let comisionFinal2 = vendedor2.comision_base

                    if (datos.factura.estadoTxt == 'Pagada') {
                        $('.btnAddDeduccion').remove()
                        const tablaDeducciones_v2 = _crearTablaDeducciones(2, true)
                        $('#divDeducciones2').append(tablaDeducciones_v2);
                    } else {
                        _btnAddDeduccion(idCliente, '2', vendedor2.nivel)
                        const tablaDeducciones_v2 = _crearTablaDeducciones(2, false)
                        $('#divDeducciones2').append(tablaDeducciones_v2);
                    }

                    // Si ya existen datos en DB
                    if (dt) {
                        let subtotal2 = 0, dt2 = []
                        dt.forEach(x => { 
                            x.forEach(n => {
                                if (n.tab == 'tab2') dt2.push(n)
                            })
                        })
                        if (dt2.length > 0) {
                            let deducciones2 = ``, i = 1;
                            dt2.forEach(x => {
                                deducciones2 += `<tr id="${x.tab}_row${i}">
                                    <td>${x.descripcion}</td>
                                    <td>${x.monto}</td>
                                </tr>`
                                subtotal2 += parseFloat(x.monto)
                                i++;
                            })
                            $('#tablaDeducciones2').append(deducciones2);
                            $('#subtotal2').text(subtotal2)
                            comisionFinal2 = parseFloat(vendedor2.comision_base-subtotal2)
                        }
                    }

                    $("#porcentaje-ganar2").css('display', 'none')
                    if (vendedor2.nivel == 4) {
                        $("#porcentaje-ganar2").css('display', 'table-row')
                        comisionFinal2 = parseFloat(comisionFinal2/2)
                    }
                    $("#total2").text(comisionFinal2)
                    $("#deduccionTotal2").val(comisionFinal2)

                }

                if (vendedor3) {
                    vendedor3.comision_base = vendedor3.comision_base.toFixed(1)
                    $("#tabFactura3").css('display', 'block')
                    $("#idVendedor3").text(vendedor3.nombre)
                    $("#nivelVendedor3").text(vendedor3.nivel)
                    $("#telVendedor3").text(vendedor3.telefono)
                    $("#comisionBase3").text(vendedor3.comision_base)
                    $("#total3").text(vendedor3.comision_base)
                    let comisionFinal3 = vendedor3.comision_base

                    if (datos.factura.estadoTxt == 'Pagada') {
                        const tablaDeducciones_v3 = _crearTablaDeducciones(3, true)
                        $('#divDeducciones3').append(tablaDeducciones_v3);
                    } else {
                        // Parametros (idCliente, Pestaña, Nivel del Vendedor)
                        _btnAddDeduccion(idCliente, '3', vendedor3.nivel)
                        const tablaDeducciones_v3 = _crearTablaDeducciones(3, false)
                        $('#divDeducciones3').append(tablaDeducciones_v3);
                    }

                    if (dt) {
                        let subtotal3 = 0, dt3 = []
                        dt.forEach(x => { 
                            x.forEach(n => {
                                if (n.tab == 'tab3') dt3.push(n)
                            })
                        })
                        
                        console.log("\nDT3 >>> ", dt3)

                        if (dt3.length > 0) {
                            let deducciones3 = ``, i = 1;
                            dt3.forEach(x => {
                                deducciones3 += `<tr id="${x.tab}_row${i}">
                                    <td>${x.descripcion}</td>
                                    <td>${x.monto}</td>
                                </tr>`
                                subtotal3 += parseFloat(x.monto)
                                i++;
                            })

                            $('#tablaDeducciones3').append(deducciones3);
                            $('#subtotal3').text(subtotal3)
                            comisionFinal3 = parseFloat(vendedor3.comision_base-subtotal3)
                        } 
                    }

                    $("#porcentaje-ganar3").css('display', 'none')
                    if (vendedor3.nivel == 4) {
                        $("#porcentaje-ganar3").css('display', 'table-row')
                        comisionFinal3 = parseFloat(comisionFinal3/2)
                    }

                    $("#total3").text(comisionFinal3)
                    $("#deduccionTotal3").val(comisionFinal3)

                }

                if (vendedor4) {
                    vendedor4.comision_base = vendedor4.comision_base.toFixed(1)
                    $("#tabFactura4").css('display', 'block')
                    $("#idVendedor4").text(vendedor4.nombre)
                    $("#nivelVendedor4").text(vendedor4.nivel)
                    $("#telVendedor4").text(vendedor4.telefono)
                    $("#comisionBase4").text(vendedor4.comision_base)
                    $("#total4").text(vendedor4.comision_base)
                    let comisionFinal4 = vendedor4.comision_base

                    if (datos.factura.estadoTxt == 'Pagada') {
                        const tablaDeducciones_v4 = _crearTablaDeducciones(4, true)
                        $('#divDeducciones4').append(tablaDeducciones_v4);
                    } else {
                        _btnAddDeduccion(idCliente, '4', vendedor4.nivel)
                        const tablaDeducciones_v4 = _crearTablaDeducciones(4, false)
                        $('#divDeducciones4').append(tablaDeducciones_v4);
                    }
                    
                    if (dt) {
                        let subtotal4 = 0, dt4 = []
                        dt.forEach(x => { 
                            x.forEach(n => {
                                if (n.tab == 'tab4') dt4.push(n)
                            })
                        })
                        if (dt4.length > 0) {
                            let deducciones4 = ``, i = 1;
                            dt4.forEach(x => {
                                deducciones4 += `<tr id="${x.tab}_row${i}">
                                    <td>${x.descripcion}</td>
                                    <td>${x.monto}</td>
                                </tr>`
                                subtotal4 += parseFloat(x.monto)
                                i++;
                            })

                            $('#tablaDeducciones4').append(deducciones4);
                            $('#subtotal4').text(subtotal4)
                            comisionFinal4 = parseFloat(vendedor4.comision_base-subtotal4)
                        } 
                    }

                    $("#porcentaje-ganar4").css('display', 'none')
                    if (vendedor4.nivel == 4) {
                        $("#porcentaje-ganar4").css('display', 'table-row')
                        comisionFinal4 = parseFloat(comisionFinal4/2)
                    }

                    $("#total4").text(comisionFinal4)
                    $("#deduccionTotal4").val(comisionFinal4)

                }

                /* -INICIO- Activar Clic para mostrar Sidebar */
                $("#btnSidebar").trigger("click");
                /* -FIN- Activar Clic para mostrar Sidebar */
                console.log("STORAGE: ", storage)
            } else {
                console.log("Ocurrió un error en él controlador")
            }
          })
    }

    // Parameros (idCliente, número de la pestaña, Contador para la fila, nivel del vendedor)
    function _agregarFila(idCliente, numTab, row, nivel) {
        $('#tablaDeducciones'+numTab).append(`<tr id="row${row}_tab${numTab}">
            <td><input type="text" id="descripcion${row}_tab${numTab}"></td>
            <td><input type="number" id="monto${row}_tab${numTab}"></td>
            <td style="display: flex;justify-content: center;">
                <a class="btn btn-primary btn-rounded btn-sm" id="btn${row}_tab${numTab}" onclick="sumarDeduccion('${idCliente}', '${numTab}', '${row}', '${nivel}')" title="Guardar">
                    <i class="fas fa-save"></i>
                </a>
                <a class="btn btn-danger btn-rounded btn-sm" onclick="eliminarFila('${idCliente}', '${numTab}', '${row}', '${nivel}')" title="Eliminar">
                    <i class="fas fa-trash-alt"></i>
                </a>
            </td>
        </tr>`);
    }

    // Parameros (idCliente, número de la pestaña, nivel del vendedor)
    function agregarDeduccion(idCliente, numTab, nivel) {
        /* VENDEDOR 1 */
        if (numTab == 'tab1') {
            _agregarFila(idCliente, 1, v1, nivel)
            v1 = v1+1;
        }

        /* VENDEDOR 2 */
        if (numTab == 'tab2'){
            _agregarFila(idCliente, 2, v2, nivel)
            v2 = v2+1;
        }

        /* VENDEDOR 3 */
        if (numTab == 'tab3'){
            _agregarFila(idCliente, 3, v3, nivel)
            v3 = v3+1;
        }

        /* VENDEDOR 4 */
        if (numTab == 'tab4'){
            _agregarFila(idCliente, 4, v4, nivel)
            v4 = v4+1;
        }

    }

    // Parameros (idCliente, número de la pestaña, número de la fila, nivel del vendedor, arrayDeducciones)
    function actualizarDeduccion(idCliente, numTab, rowTab, nivelVendedor, deducciones) {
        // console.log("\nDATOS RECIBIDOS POR ACTUALIZAR DEDUCCIONES >>>> ", deducciones)
        const tab = 'tab'+numTab
        const filtroDeducciones = deducciones.filter((i) => i.tab == tab) //Filtrar por pestañas o vendedor
        const subTotal = filtroDeducciones.map(i => i.monto).reduce((prev, curr) => prev + curr, 0);
        const comisionTotal = $('#deduccionTotal'+numTab)
        $('#subtotal'+numTab).text('')
        $('#subtotal'+numTab).text(subTotal)

        let total = $("#comisionBase"+numTab).text()
        total = parseFloat(total-subTotal).toFixed(1)
        comisionTotal.val(total)

        if (nivelVendedor == '4' || nivelVendedor == 4) {
            const valor = $("#comisionBase"+numTab).text()
            total = parseFloat((valor-subTotal)/2).toFixed(1)
            comisionTotal.val(total)
        }

        $('#total'+numTab).text(total)
        const idFactura = $("#idFacturaActual").val();
        storage.vendedores.forEach(data => {
            if (data.nivel == nivelVendedor) {
                data.comision_final = parseFloat(total);
                data.deducciones = filtroDeducciones
            }
        });

        console.log("NEW STORAGE >>> ", storage)

        // OPERACIONES PARA COSTOS ADICIONALES - ÚLTIMO TAB
        const gananciaTotal0 = storage.vendedores.map(x => x.comision_final).reduce((prev, curr) => prev + curr, 0);
        const gananciaBase = parseFloat(storage.monto_aprobado)-parseFloat(gananciaTotal0).toFixed(1);
        const actualizarGanancia = parseFloat(gananciaBase)-parseFloat(subtotalCostos.text())

        $("#gananciaBase").text(gananciaBase)
        totalGanancias.text(parseFloat(actualizarGanancia))
        gananciaTotal.val(parseFloat(actualizarGanancia))
        
        storage.gananciaBase = parseFloat(gananciaBase);
        storage.gananciaTotal = parseFloat(gananciaTotal.val());

        console.log("Comisión Total VENDEDORES >>> ", gananciaTotal0)
        console.log("Ganancia Base ACTUALIZADA >>> ", gananciaBase)
        console.log("\nTOTAL GANANCIA >>> ", gananciaTotal.val())
        /////////////////////////////////////////////////////////////////////////////////////////////////////
    }

    // Parameros (idCliente, número de la pestaña, Contador para la fila, nivel del vendedor)
    function sumarDeduccion(idCliente, numTab, row, nivelVendedor) {
        $('#descripcion'+row+'_tab'+numTab).attr('disabled', 'disabled');
        $('#monto'+row+'_tab'+numTab).attr('disabled', 'disabled');
        $('#btn'+row+'_tab'+numTab).css('display', 'none');
        let monto = $('#monto'+row+'_tab'+numTab).val()
        monto = parseFloat(monto)
        const descripcion = $('#descripcion'+row+'_tab'+numTab).val()
        let sumatoriaDeduccion = 0;
        const tab = 'tab'+numTab
        const rowTab = 'row'+row+'_tab'+numTab
        arrayDeducciones.push({idCliente,  tab, row, rowTab, descripcion, monto, nivelVendedor})

        // Aplicar cambios (subtotal y total)
        actualizarDeduccion(idCliente, numTab, rowTab, nivelVendedor, arrayDeducciones)
    }

    function eliminarFila(idCliente, numTab, row, nivelVendedor) {
        $('#row'+row+'_tab'+numTab).remove()
        const arrayResultado = arrayDeducciones.filter((i) => i.rowTab !== 'row'+row+'_tab'+numTab)
        // const filtroTab = arrayDeducciones.filter((i) => i.tab == 'tab'+numTab)
        // console.log("\nEDIT >>>", filtroTab)
        // const arrayResultado = filtroTab.filter((i) => i.row !== row)
        arrayDeducciones = arrayResultado
        const rowTab = 'row'+row+'_tab'+numTab
        console.log("Datos sin la fila Eliminada >>>", arrayDeducciones)
        actualizarDeduccion(idCliente, numTab, rowTab, nivelVendedor, arrayDeducciones)
    }

    /* ------------------------------------------------------ COSTOS ------------------------------------------------------ */
    function agregarCosto() {
        const idCliente = $("#idCliente_").val()
        $('#tablaCostosExtras').append(`<tr id="row${cont}_Costos">
            <td><input type="text" id="descripcion${cont}_Costos"></td>
            <td><input type="number" id="monto${cont}_Costos"></td>
            <td style="display: flex;justify-content: center;">
                <a class="btn btn-primary btn-rounded btn-sm" id="btn${cont}_Costos" onclick="sumarCostos('${idCliente}', '${cont}')" title="Guardar">
                    <i class="fas fa-save"></i>
                </a>
                <a class="btn btn-danger btn-rounded btn-sm" onclick="eliminarCosto('${idCliente}', '${cont}')" title="Eliminar">
                    <i class="fas fa-trash-alt"></i>
                </a>
            </td>
        </tr>`);
        cont++;
    }

    function eliminarCosto(idCliente, n) {
        $('#row'+n+'_Costos').remove()
        const arrayResultado = arrayCostos.filter((i) => i.row !== 'row'+n+'_Costos')
        arrayCostos = arrayResultado
        console.log("\nARRAY COSTOS SIN LA FILA ELIMINADA >>>>", arrayCostos)
        actualizarGanancias(idCliente, arrayCostos)
    }

    function sumarCostos(idCliente, n) {
        $('#descripcion'+n+'_Costos').attr('disabled', 'disabled');
        $('#monto'+n+'_Costos').attr('disabled', 'disabled');
        $('#btn'+n+'_Costos').css('display', 'none');
        let monto = $('#monto'+n+'_Costos').val()
        monto = parseFloat(monto)
        const descripcion = $('#descripcion'+n+'_Costos').val()
        let sumatoriaCostos = 0;
        arrayCostos.push({idCliente, row: 'row'+n+'_Costos', descripcion, monto})
        // Aplicar cambios (subtotal y total Ganancias)
        actualizarGanancias(idCliente, arrayCostos)
    }

    // Parametros => ID Cliente, # de la Fila, Nombre de la Fila, ArrayCostos
    function actualizarGanancias(idCliente, costos) {
        const subTotal = costos.map(i => i.monto).reduce((prev, curr) => prev + curr, 0);
        const gananciaBase = $('#gananciaBase').text()
        subtotalCostos.text('')
        subtotalCostos.text(subTotal)

        const total = parseFloat(gananciaBase-subTotal).toFixed(1)
        gananciaTotal.val(total)

        $('#totalGanancias').text(total)
        storage.gananciaBase = parseFloat(gananciaBase);
        storage.gananciaTotal = parseFloat(total);
        storage.costosOperativos = costos;

        console.log("NEW STORAGE >>> ", storage)
    }

    /* REPORTAR FACTURA COMO PAGADA - Parametros (id de la factura Ej: 000001) */
    function reportarFactura(factura) {
        // console.log("DATA >>>> ---", JSON.parse(storage)) 
        Swal.fire({
            title: '¿Seguro que desea reportar esta factura?',
            text: 'Al repotar la factura, confirmas que ya ha sido pagada a los vendedores.',
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Confirmar',
            cancelButtonText: `Cancelar`,
        }).then((result) => {
            if (result.isConfirmed) {
                console.log("\n\nDatos a comparar para enviar >>>",storage)
                if (storage.factura.id == factura) {

                    const dataVendedores = storage.vendedores;
                    const idCliente = storage.idCliente
                    const id_cliente = storage.id_cliente
                    const producto_instalado = storage.sistema
                    const costos_adicionales = storage.costosOperativos;
                    const ganancias_empresa = {base: storage.gananciaBase, total: storage.gananciaTotal}

                    fetch('/efectuarVenta', {
                        method: 'POST',
                        body: JSON.stringify({factura, dataVendedores, idCliente, producto_instalado, costos_adicionales, ganancias_empresa}),
                        headers: {'Content-Type': 'application/json'}
                    }).then(res => res.json())
                        .catch(error => console.error('Error:', error))
                        .then(datos => {
                            if (datos) {
                                Swal.fire({
                                    position: 'top-end',
                                    icon: 'success',
                                    title: 'Reporte exitoso!',
                                    showConfirmButton: false,
                                    timer: 1500
                                }).then((respu) => {
                                    setTimeout('document.location.reload()', 800);
                                })
                            }
                    })

                } else {
                    Swal.fire('Incosistencia con los datos!', 'Por favor conctactar con soporte', 'error')
                }
                
            } 
            
        })
        
    }

</script>

</body>

</html>